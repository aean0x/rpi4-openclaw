#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")"

# Find a readable age key
find_key() {
    if [ -r key.txt ]; then
        echo "key.txt"
    elif [ -r /var/lib/sops-nix/key.txt ]; then
        echo "/var/lib/sops-nix/key.txt"
    else
        echo ""
    fi
}

# Generate or find a key
KEY_PATH=$(find_key)

if [ -z "$KEY_PATH" ]; then
    echo "No key found. Generating new age key..."
    age-keygen -o key.txt
    KEY_PATH="key.txt"
fi

PUBLIC_KEY=$(age-keygen -y "$KEY_PATH")
echo "Using key: $KEY_PATH"
echo "Public key: $PUBLIC_KEY"

# Check if .sops.yaml exists and whether it matches our key
SOPS_CONFIG_MATCHES=false
if [ -f .sops.yaml ]; then
    if grep -q "$PUBLIC_KEY" .sops.yaml; then
        SOPS_CONFIG_MATCHES=true
    fi
fi

# Check if we can decrypt existing secrets.yaml
CAN_DECRYPT=false
if [ -f secrets.yaml ] && [ "$SOPS_CONFIG_MATCHES" = true ]; then
    if SOPS_AGE_KEY_FILE="$KEY_PATH" SOPS_CONFIG="$(pwd)/.sops.yaml" sops -d secrets.yaml > /dev/null 2>&1; then
        CAN_DECRYPT=true
    fi
fi

# Determine if this looks like a fork situation:
# - .sops.yaml exists but doesn't have our key, OR
# - secrets.yaml exists but we can't decrypt it
IS_FORK=false
if [ -f .sops.yaml ] && [ "$SOPS_CONFIG_MATCHES" = false ]; then
    IS_FORK=true
fi
if [ -f secrets.yaml ] && [ "$CAN_DECRYPT" = false ]; then
    IS_FORK=true
fi

# Handle fork situation
if [ "$IS_FORK" = true ]; then
    echo ""
    echo "=========================================="
    echo "FORK DETECTED"
    echo "=========================================="
    echo ""
    echo "The existing .sops.yaml and/or secrets.yaml were encrypted"
    echo "with a different key than yours. This typically happens when"
    echo "you fork a repo but don't have the original author's private key."
    echo ""
    echo "To proceed, we need to:"
    echo "  1. Regenerate .sops.yaml with YOUR public key"
    echo "  2. Create new secrets.yaml from the template"
    echo ""
    echo "Reset secrets configuration for your key? [y/N] "
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        rm -f .sops.yaml secrets.yaml
        echo "Removed old .sops.yaml and secrets.yaml"
    else
        echo "Aborting. You can manually delete .sops.yaml and secrets.yaml to start fresh."
        exit 1
    fi
fi

# Create .sops.yaml if missing
if [ ! -f .sops.yaml ]; then
    cat > .sops.yaml << EOF
creation_rules:
  - path_regex: .*secrets\.yaml(\.work)?$
    key_groups:
      - age:
          - ${PUBLIC_KEY}
EOF
    echo "Created .sops.yaml with your public key"
fi

# Offer to copy key to system location
if [ -f key.txt ] && [ ! -f /var/lib/sops-nix/key.txt ]; then
    echo ""
    echo "Copy key to /var/lib/sops-nix/key.txt? (required for NixOS) [y/N] "
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        sudo mkdir -p /var/lib/sops-nix
        sudo cp key.txt /var/lib/sops-nix/key.txt
        sudo chmod 600 /var/lib/sops-nix/key.txt
        echo "Key copied."
    fi
fi

# Determine what to do with secrets
if [ -f secrets.yaml.work ]; then
    echo "Found existing secrets.yaml.work"
elif [ -f secrets.yaml ]; then
    echo "Decrypting existing secrets.yaml for editing..."
    SOPS_AGE_KEY_FILE="$KEY_PATH" SOPS_CONFIG="$(pwd)/.sops.yaml" sops --input-type=yaml --output-type=yaml -d secrets.yaml > secrets.yaml.work
    echo "Decrypted to secrets.yaml.work"
else
    if [ -f secrets.yaml.example ]; then
        cp secrets.yaml.example secrets.yaml.work
        echo ""
        echo "Created secrets.yaml.work from template."
        echo "Opening in nano - fill in your values, then save and exit."
        sleep 2
        nano secrets.yaml.work
    else
        echo "Error: secrets.yaml.example not found"
        exit 1
    fi
fi

# Final encryption
if [ -f secrets.yaml.work ]; then
    SOPS_AGE_KEY_FILE="$KEY_PATH" SOPS_CONFIG="$(pwd)/.sops.yaml" sops --input-type=yaml --output-type=yaml -e secrets.yaml.work > secrets.yaml
    echo "Encrypted secrets.yaml.work -> secrets.yaml"
    rm secrets.yaml.work
else
    echo "Error: No secrets.yaml.work file found"
    exit 1
fi

echo ""
echo "Done! secrets.yaml is ready."
