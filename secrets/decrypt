#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")"

# Function to find a readable age key
find_key() {
    if [ -r key.txt ]; then
        echo "key.txt"
    elif [ -r /var/lib/sops-nix/key.txt ]; then
        echo "/var/lib/sops-nix/key.txt"
    else
        echo ""
    fi
}

KEY_PATH=$(find_key)

# Check if key exists anywhere
if [ -z "$KEY_PATH" ]; then
    if [ -f /var/lib/sops-nix/key.txt ]; then
        echo "Error: /var/lib/sops-nix/key.txt exists but is not readable"
        echo "Fix with: sudo cp /var/lib/sops-nix/key.txt key.txt && sudo chown \$USER key.txt"
    else
        echo "Error: No key found in either ./key.txt or /var/lib/sops-nix/key.txt"
        echo "Please run ./encrypt first to generate a key"
    fi
    exit 1
fi

echo "Using key: $KEY_PATH"

# Check if encrypted secrets exist
if [ ! -f secrets.yaml ]; then
    echo "Error: secrets.yaml not found. Please run ./encrypt first"
    exit 1
fi

# Decrypt secrets to working file
SOPS_AGE_KEY_FILE="$KEY_PATH" SOPS_CONFIG=.sops.yaml sops --input-type=yaml --output-type=yaml -d secrets.yaml > secrets.yaml.work
echo "Decrypted secrets.yaml to secrets.yaml.work"
echo "IMPORTANT: Edit secrets.yaml.work, then run ./encrypt to save changes"
