#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")"

HOST=$(grep -oP 'hostName\s*=\s*"\K[^"]+' settings.nix)
USER=$(grep -oP 'adminUser\s*=\s*"\K[^"]+' settings.nix)
IP=$(grep -oP 'address\s*=\s*"\K[^"]+' settings.nix)

TARGET="${USER}@${HOST}.local"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}==>${NC} $*"; }
warn() { echo -e "${YELLOW}==> WARNING:${NC} $*"; }
error() { echo -e "${RED}==> ERROR:${NC} $*" >&2; }

usage() {
    echo "Usage: $0 <command> [args]"
    echo ""
    echo "Remote wrapper for OpenClaw gateway management."
    echo ""
    echo "Commands:"
    echo "  ssh                  Interactive SSH"
    echo "  help                 Show Pi commands"
    echo ""
    echo "On-device lifecycle:"
    echo "  switch               nixos-rebuild switch"
    echo "  boot                 nixos-rebuild boot"
    echo "  try                  nixos-rebuild test"
    echo "  update               Update flake inputs and switch"
    echo "  rollback             Roll back to previous generation"
    echo "  cleanup              Garbage collect and optimize store"
    echo "  system-info          Show system status"
    echo ""
    echo "Troubleshooting:"
    echo "  docker-ps            List containers"
    echo "  docker-stats         One-shot resource snapshot"
    echo "  logs [container]     Tail container logs (default: openclaw-gateway)"
    echo "  journal [unit]       Tail system logs"
    echo ""
    echo "OpenClaw CLI:"
    echo "  openclaw <cmd>       Run any openclaw CLI command (e.g. openclaw onboard)"
    echo ""
    echo "Workstation remote-build:"
    echo "  remote-switch        Build on workstation and switch"
    echo "  remote-boot          Build on workstation, activate on reboot"
    echo "  remote-try           Build on workstation, activate temporarily"
    echo "  remote-build         Build on workstation only"
    echo "  build-sd             Build SD card image (initial setup)"
    exit 1
}

[[ $# -lt 1 ]] && usage

CMD="$1"
shift

check_aarch64_support() {
    info "Checking aarch64-linux build support..."

    [[ "$(uname -m)" == "aarch64" ]] && { info "Running on aarch64 natively"; return 0; }

    if [[ -f /proc/sys/fs/binfmt_misc/aarch64 ]] || [[ -f /proc/sys/fs/binfmt_misc/aarch64-linux ]]; then
        info "binfmt/qemu aarch64 emulation available"
        return 0
    fi

    if grep -q "aarch64-linux" ~/.config/nix/nix.conf 2>/dev/null || grep -q "aarch64-linux" /etc/nix/nix.conf 2>/dev/null; then
        info "Remote aarch64 builder configured"
        return 0
    fi

    if nix show-config 2>/dev/null | grep -q "extra-platforms.*aarch64-linux"; then
        info "aarch64-linux in extra-platforms"
        return 0
    fi

    error "No aarch64-linux build support detected."
    exit 1
}

check_ssh() {
    info "Testing SSH connection to ${TARGET}..."
    if ssh -o ConnectTimeout=5 -o BatchMode=yes -o StrictHostKeyChecking=accept-new "$TARGET" true 2>/dev/null; then
        info "SSH connection OK (${TARGET})"
        return 0
    fi

    warn "Could not connect to ${TARGET}, trying IP (${IP})..."
    TARGET="${USER}@${IP}"
    ssh -o ConnectTimeout=5 -o BatchMode=yes -o StrictHostKeyChecking=accept-new "$TARGET" true 2>/dev/null || {
        error "SSH failed"
        exit 1
    }
    info "SSH connection OK (${TARGET})"
}

build_system() {
    info "Building NixOS configuration for ${HOST}..."
    nix build ".#nixosConfigurations.${HOST}.config.system.build.toplevel" \
        --print-build-logs \
        --show-trace \
        "$@"
}

deploy_system() {
    local action="$1"
    local result_path
    result_path="$(readlink -f result)"

    if [[ "$action" == "build" ]]; then
        info "Build-only mode, skipping deployment"
        return 0
    fi

    info "Copying system closure to ${TARGET}..."
    export NIX_SSHOPTS="-o StrictHostKeyChecking=accept-new"
    nix copy --to "ssh-ng://${TARGET}?remote-program=sudo%20nix-daemon" --no-check-sigs "$result_path"

    info "Activating system (${action})..."
    ssh -t -o StrictHostKeyChecking=accept-new "$TARGET" "sudo nix-env -p /nix/var/nix/profiles/system --set \"$result_path\"; sudo \"$result_path/bin/switch-to-configuration\" \"$action\""

    info "Deployment complete!"
}

build_sd_image() {
    check_aarch64_support

    info "Setting up SOPS encryption..."
    (cd secrets && ./encrypt)

    local KEY_PATH=""
    if [ -r "$(pwd)/secrets/key.txt" ]; then
        KEY_PATH="$(pwd)/secrets/key.txt"
    elif [ -r /var/lib/sops-nix/key.txt ]; then
        KEY_PATH="/var/lib/sops-nix/key.txt"
    else
        error "No key found"
        exit 1
    fi

    export KEY_FILE_PATH="$KEY_PATH"
    info "Building SD card image..."
    nix build .#packages.aarch64-linux.sdImage --impure

    info "SD image built successfully!"
    echo "Output: result/sd-image/*.img.zst"
    echo ""
    echo "Flash with:"
    echo "  zstdcat result/sd-image/*.img.zst | sudo dd of=/dev/sdX bs=4M status=progress"
}

# Run openclaw CLI command inside the container
run_openclaw() {
    ssh -t -o StrictHostKeyChecking=accept-new "$TARGET" \
        "sudo docker exec -it openclaw-gateway node dist/index.js $*"
}

case "$CMD" in
    -h|--help)
        usage
        ;;

    ssh)
        check_ssh
        exec ssh -o StrictHostKeyChecking=accept-new "$TARGET"
        ;;

    help)
        check_ssh
        ssh -o StrictHostKeyChecking=accept-new "$TARGET" "help"
        ;;

    switch|boot|try)
        check_ssh
        ssh -t -o StrictHostKeyChecking=accept-new "$TARGET" "$CMD" "$@"
        ;;

    build-sd)
        build_sd_image
        ;;

    remote-switch|remote-boot|remote-try|remote-build)
        check_aarch64_support
        check_ssh

        ACTION="${CMD#remote-}"
        case "$ACTION" in
            try) ACTION="test" ;;
        esac

        build_system
        deploy_system "$ACTION"
        ;;

    openclaw)
        check_ssh
        run_openclaw "$@"
        ;;

    *)
        check_ssh
        ssh -t -o StrictHostKeyChecking=accept-new "$TARGET" "$CMD" "$@"
        ;;
esac
